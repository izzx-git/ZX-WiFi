ZX WiFi
Плата содержит порт Кондратьева с адресом #yyEF (на новых версиях возможно #yyEE), 
к которому подключен встроенный модуль WiFi (ESP12E/F) 
и преобразователь RS-232 для проводного соединения.
Поддерживает автоматический контроль потока (AFE).

Обсуждение тут:
https://zx-pk.ru/threads/33138-opros-wifi-dlya-zx-klonov-ne-na-fpga.html

Основана на схеме для MSX:
https://github.com/andortizg/BaDCaT
И для Sprinter:
https://github.com/romychs/SprinterESP
И Evolution:
http://nedopc.com/zxevo/zxevo_sch_revc.pdf

v.1.0 - Сигнал шины IORQGE не формирует. Для перепрошивки ESP нужна доработка.
v.1.1 - Добавлены перемычки для перепрошивки ESP.
v.1.2 - Добавлен сигнал IORQGE на элементе U6.
v.1.3 - Учтён сигнал М1, заменены U2, U6. Перемычка выбора порта EF/EE. Разъём для светодиода активности.
v.1.4 - Слот на 60-62 контакта, можно отпилить до 56. Заведён сигнал сброса от компьютера на ESP и на 16550. 
	Добавлен преобразователь 5В-3.3В вместо резисторов. Антенна ESP вынесена за пределы текстолита.
v.1.5 - Вместо микросхемы TXB0104 обратно поставлены резисторы. Добавлены резисторы подтяжки на RX TX.
	На 5 контакте шины пропилен ключ. Вернулись перемычки для прошивки X5, X6. Добавлены номиналы всего на шелкографии.

Проверялось на: 
Scorpion Turbo+/GMX (вместе со SMUC, GS. С активной "ёлкой" может влиять порядок плат).
Scorpion Turbo+ (нужен сигнал IORQGE - плата v1.2 и выше, или отключить DD53 - порт #FF).
Spectrum +2A
Kay 1024
Evolution rev C (плата v1.3, включить порт EE и настроить программы на этот порт)

Версии до 1.3 не работают на:
ZX Evolution (уже есть такой порт).
С картой ZXMC (такой же порт)

Софт:
AY232K (копирование данных ZX - сервер PC)
Moon Rabbit (gopher браузер)
Network Manager (Netman, настройка на точку доступа)
NetTime (синхронизация часов SMUC через инет)
Melon (терминал)
PlatoTerm (терминал)
другой софт для порта Кондратьева. Подробнее на форуме.

Размеры и параметры производства:
Версии до 1.4:
73.4x63.9mm 2 слоев, Толщина:1.6 mm, Финишная медь:1, Поверхностная
обработка: HASL with lead
Версия 1.4: 
81.14x63.9mm

Первоначальную настройку ESP12E на свою точку доступа можно выполнить:
- с помощью программы Network Manager
- через разъём для программирования X2 и терминал.
Менять заводскую прошивку, скорее всего, не придётся.
Со стандартным кварцем больше настроек не требуется.
ESP после включения должен мигать два-три раза и подключаться к ТД.

Версии до 1.4:
Длина краевого разъёма чуть меньше, чем у современных, с шагом 2.54. Примерно на 1 мм. 
Должно подходить и к старым разъёмам тоже, с шагом 2.5.
Устанавливать плату максимально совмещая 1 и 28 контакты, и правильной стороной.
В современный 28ти контактный разъём устанавливается надёжно, если контактов больше - можно ошибиться.
1й контакт стороны B слева внизу, если смотреть на плату со стороны деталей.
Сторона A считается та, где контакт +5В (нижняя, как на оригинальном ZX).
Для оригинального ZX можно спаять переходник из двух разъёмов на 56 контактов.
Версия 1.4:
Должна точно подходить в разъём 62 контакта. Можно отломить до 60. Используются только 56.

Внимание: кабель com (232) подключать на полностью выключенном оборудовании. Телевизор/монитор тоже выключить. 
были случаи выхода из строя микросхемы max3232 из-за разницы потенциалов между землями устройств. 
Для страховки можно заранее соединить земли отдельным проводом.

Если к плате не подключено какое-либо устройство через RS-232, 
то, возможно, надо установить перемычку между контактами 7-8 X3 (RTS замкнуть на CTS).
Иначе Max3232 может мешать работе ESP. 

Если проводное соединение не нужно, Max3232 и его обвязку можно не запаивать, тогда перемычка (и разъём X3) не нужны.
Резисторы R3,4,5, вероятно, тоже можно не устанавливать.
Номинал резисторов R8,9,10,11 можно выбирать примерно похожий, а, может быть, обойтись перемычками (не проверено).
Кварц можно поставить другой. Не больше 16MHZ. Но учесть это при работе. 
Например, кварц 14.7456MHZ даст прирост скорости в 8 раз при том же делителе. 
Тогда скорость UART для ESP нужно установить 921600, для делителя = 1. 

Разъём X2, (и X5, X6 в версии 1.1), кнопки RST и PRG  для программировния ESP
Разъём X3 для подключения стандартной планки RS-232 (планки попадаются с разной распайкой, надо учесть).
Разъём X4 для подключения внешней кнопки сброса ESP.
Перемычки X5, X6 должны быть замкнуты.
В версии 1.4 вместо X5, X6 перемычка J2. Замкнуть для перепрошивки.

Программирование ESP через разъём X2 для версии 1.0:
Если на этой плате сделать доработки как в версии 1.1, то можно прошивать как и новую версию платы (см. ниже).
Плату от компьютера отключить.
Переключатель SW1 в положение "232", перемычку с X3 убрать (возможно, не обязательный пункт.)
Подключить UART-TTL переходник согласно схеме (+3.3, RX, TX, GND).
Питания от переходника может не хватить, требуется отдельное.

Программирование ESP через разъём X2 для версии 1.1 - 1.3:
Плату можно оставить в компьютере, для питания ESP.
Тогда переключатель SW1 в положение "ESP" (питание от компьютера).
Перемычки X5, X6 убрать (или замкнуть J2 на новых версиях).
Подключить UART-TTL переходник согласно схеме (RX, TX, GND). 

Для подключения терминала (если надо): скорость заводская 115200-8-1, без аппаратного контроля. 

Прошивка:
Вариант 1: Нажать кнопку PRG, затем  нажать и отпустить RST, затем отпустить PRG.
Вариант 2: На выключенной плате нажать кнопку PRG и включить питание.
Можно программировать (через FLASH_DOWNLOAD_TOOLS).
Прошивка есть в папке AY232.

Разъём X2:
1 - 3.3V  
2 - TXD ESP
3 - RXD ESP
4 - GND

Дешифрация порта #F8EF-#FFEF:
xxxxxyyy11101111
где
x - любое значение
y - выбор внутреннего порта

Как определить наличие карты:
из бейсика дать команду IN 239
с картой ответ будет 0 (иногда могут быть другие цифры), без карты - 255.
Test4.30 может обнаружить модем, и одновременно порт 255, если всё нормально работает.

Подробнее о программной настройке.
(при подключении проводом ESP настраивать не требуется).

Если кварц стоит не 1.8432Мгц, нужно настроить делитель микросхемы 16C550 и параметры UART ESP,
чтобы скорость обмена была одинаковая.
После включения платы делитель 1.
Рассчёт. Частоту надо разделить на 16, затем на делитель.:
1843200/16=115200
Оставляем делитель 1. 
115200/1=115200. Микросхема 16C550 будет работать на такой скорости.
Значит и ESP надо настроить на 115200.

Если делитель 2:
1843200/16/2=57600. Значит, на ESP тоже ставим 57600.

Для кварца 14.7456:
14745600/16/1=921600.

Поправить значение делителя в файлах zx-wifi.asm и собрать программы.
Искать строку в moon-rabbit-zx, AY232K, Netman-zx:
    outp RBR_THR, #01  

В Netman-zx значение скорости UART ESP:
set_speed_cmd db "AT+UART_DEF=115200,8,1,0,3", 13, 10, 0


Пример простого перехода с кварца 1.8432 на другой. Если уже всё работает, то: 

1.Поменять в программе NetMan скорость 115200, на  скорость, соответствующую новому кварцу. 
Строка 115 в файле zx-wifi.asm папки drivers
115 set_speed_cmd db "AT+UART_DEF=115200,8,1,0,3", 13, 10, 0
2. Запустить файл _Build_Trdos.bat. Он создаст новый trd-образ прогаммы NetMan
3. Загрузить измененную программу, она перенастроит модуль ESP-12 на новую скорость.
4. Заменить кварц.
5. Запустить измененную программу NetMan и установить Wi-Fi соединение.
 
В программах AY232K, Moon Rabbit, Nettime ничего менять не нужно.
Скорость порта = частота кварца/16 Максимальная частота 14,7456 МГц соответствует скорости порта 921600 бод.




Доработки (см. снимки в папке Фото):

Версия 1.0
Для перепрошивки нужно временно отрезать от ESP сигналы RX и TX
(или выпаять резисторы R10,11) и подключиться к ESP напрямую. Или установить самодельные перемычки.
Возможно, не потребуется, если не установлен Max3232.
В версии 1.1 для этого установлены перемычки X5, X6, ничего резать не надо.

Версия 1.1
Можно добавить сигнал iorqge, напаяв микросхему SN74LVC1G125DBVR.

Версия 1.2
Можно для усиления сигнала iorqge установить транзистор, например КТ315Б,
или защитить микросхему LVC1G125 включив в разрыв на выходе резистор 47 Ом.

Есть предположение, что ESP может давать помехи. Положительно влияет установка других плат в соседние разъёмы.
Для повышения стабильности работы можно добавить конденсатор 68 pF между сигналом WR и землёй.
Так же для сигнала RD.

Версия 1.3
Если ESP не всегда запускается при включении, можно притянуть к питанию 3.3 через резистор 10к-100к вывод TXD (22) ESP.

Версия 1.4
У микросхемы U7 отрезать дорожку у ноги 12 (или поднять эту ногу). И кинуть перемычку на ногу 3. То есть, исключаем эту часть схемы.
Задача соединить напрямую SIN (11) 16550 и TXD (22) ESP  мимо микросхемы TXB0104.
Перемычка J2 PRG не будет полноценно работать. Это влияет только на удобство перепрошивки.

